@model VendorEditVm
@{
    ViewData["Title"] = "Edit Vendor";
    var emailList = (Model.Emails ?? "")
        .Split(';', StringSplitOptions.RemoveEmptyEntries)
        .Select(e => e.Trim())
        .ToList();
    var extraSlots = 3; // number of blank email inputs to show for adding new
}

<section class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h1 class="h5 mb-1">Edit Vendor – @Model.Name</h1>
            <div class="small text-muted">Update notification settings, contact details and comments.</div>
        </div>
        <div>
            <a asp-controller="Vendors" asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary btn-sm me-2">
                Back to details
            </a>
            <a asp-controller="Vendors" asp-action="Index" class="btn btn-outline-secondary btn-sm">
                Vendor list
            </a>
        </div>
    </div>

    <div class="row g-3">
        <!-- Left: editable form -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <form asp-controller="Vendors" asp-action="Edit" method="post" data-email-sync="true">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Id" />

                        <!-- Name (read-only here) -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Vendor name</label>
                            <input class="form-control" value="@Model.Name" disabled />
                            <div class="form-text">Name can be edited only by admin.</div>
                        </div>

                        <!-- Live -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input asp-for="Live" class="form-check-input" type="checkbox" id="LiveSwitch" />
                                <label class="form-check-label" for="LiveSwitch">Live</label>
                            </div>
                        </div>

                        <hr class="my-3" />

                        <!-- Emails (UI list, semicolon string in hidden field) -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Emails</label>
                            <div class="small text-muted mb-1">
                                One email per line. Clear a line to remove it. Empty lines are ignored.
                            </div>

                            <div class="row g-2" id="emailList">
                                @foreach (var email in emailList)
                                {
                                    <div class="col-12 col-md-6">
                                        <input type="email"
                                               class="form-control form-control-sm"
                                               name="EmailsArray"
                                               data-email-item="true"
                                               value="@email" />
                                    </div>
                                }

                                @for (var i = 0; i < extraSlots; i++)
                                {
                                    <div class="col-12 col-md-6">
                                        <input type="email"
                                               class="form-control form-control-sm"
                                               name="EmailsArray"
                                               data-email-item="true"
                                               value="" />
                                    </div>
                                }
                            </div>

                            <!-- Hidden field bound to model.Emails (semicolon-separated) -->
                            <input type="hidden" asp-for="Emails" id="EmailsHidden" />
                            <div class="form-text">Stored internally as a semicolon-separated list.</div>
                        </div>

                        <hr class="my-3" />

                        <!-- Notification + phones + deadline -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Zero order notification</label>
                                <div class="form-check">
                                    <input asp-for="ZeroOrderNotification" class="form-check-input" type="checkbox" id="ZeroOrderNotification" />
                                    <label class="form-check-label" for="ZeroOrderNotification">Enabled</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Deadline" class="form-label fw-semibold">Deadline</label>
                                <input asp-for="Deadline" class="form-control" type="time" />
                                <span asp-validation-for="Deadline" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="AruCallingId" class="form-label fw-semibold">ARU Calling ID</label>
                                <input asp-for="AruCallingId" class="form-control" />
                                <span asp-validation-for="AruCallingId" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="AruPhone" class="form-label fw-semibold">ARU Phone</label>
                                <input asp-for="AruPhone" class="form-control" />
                                <span asp-validation-for="AruPhone" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="VendorPhone" class="form-label fw-semibold">Vendor phone</label>
                                <input asp-for="VendorPhone" class="form-control" />
                                <span asp-validation-for="VendorPhone" class="text-danger small"></span>
                            </div>
                        </div>

                        <hr class="my-3" />

                        <!-- Comments -->
                        <div class="mb-3">
                            <label asp-for="Comments" class="form-label fw-semibold">Comments</label>
                            <textarea asp-for="Comments" class="form-control" rows="4"></textarea>
                            <span asp-validation-for="Comments" class="text-danger small"></span>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <a asp-controller="Vendors" asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">
                                Cancel
                            </a>
                            <button type="submit" class="btn btn-cta-red">
                                Save changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right: read-only info (same as full page but non-edit) -->
        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-body">
                    <h2 class="h6 mb-3">Summary</h2>
                    <div class="small">
                        <div class="mb-1"><span class="text-muted">CEO account:</span> @Model.CeoAccount</div>
                        <div class="mb-1"><span class="text-muted">CEO location:</span> @Model.CeoLocation</div>
                        <div class="mb-1"><span class="text-muted">ARU passcode:</span> ••••••</div>
                        <div class="mb-1"><span class="text-muted">Vault lead adj:</span> ₹ @Model.VaultLeadAdjustment</div>
                        <div class="mb-1"><span class="text-muted">Vault CC offset:</span> ₹ @Model.VaultCcOffset</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h2 class="h6 mb-2">Quick links</h2>
                    <div class="list-group list-group-flush">
                        <a asp-controller="Orders" asp-action="Bulk" asp-route-vendorId="@Model.Id" class="list-group-item small">
                            Bulk orders
                        </a>
                        <a asp-controller="Orders" asp-action="Atm" asp-route-vendorId="@Model.Id" class="list-group-item small">
                            ATM orders
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            function syncEmails(form) {
                var values = [];
                form.querySelectorAll('[data-email-item]').forEach(function (input) {
                    var v = (input.value || '').trim();
                    if (v) values.push(v);
                });
                var hidden = form.querySelector('#EmailsHidden');
                if (hidden) {
                    hidden.value = values.join(';'); // semicolon-separated
                }
            }

            document.querySelectorAll('form[data-email-sync="true"]').forEach(function (form) {
                form.addEventListener('submit', function () { syncEmails(form); });
            });
        })();
    </script>
}